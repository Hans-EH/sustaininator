{% extends 'auth_base.html' %} {% block content %}

<!-- Chart.js dependencies -->
<!--script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script-->
<h1>{{ device.name }}</h1>

<body>
  <div class="row mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between">
          <div class="d-flex align-items-center">
            <p class="my-0">Power Consumption</p>
          </div>
        </div>
        <div class="card-body">
          <canvas id="deviceEnergy"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="row mb-3">
    <div class="col-3">
      <div class="mini-card card h-100 text-center">
        <div class="card-header">
          <h6>Device Power</h6>
        </div>
        <div class="card-body">
          <p>{{device.power}} Watts</p>
        </div>
      </div>
    </div>
    <div class="col-3">
      <div class="mini-card card h-100 text-center">
        <div class="card-header">
          <h6>Device Energy Consumption Today</h6>
        </div>
        <div class="card-body">
          <div id="dailyEnergyUse"> kWh</div>
        </div>
      </div>
    </div>
    <div class="col-3">
      <div class="mini-card card h-100 text-center">
        <div class="card-header">
          <h6>Device Lifetime Energy Consumption</h6>
        </div>
        <div class="card-body">
          <div id="lifetimeEnergyUse">{{device.lifetime_energy_consumption}} kWh</div>
        </div>
      </div>
    </div>
  </div>
</body>

<!-- Displays the daily energy use graph-->
<script>

  //Get the probability vector passed down from the controller
  let probVector = "{{probVector}}";
  //Convert to an array
  probVector = probVector.split(",");
  // Get device's energy use for the past 24 h
  let pastDay = "{{device.energy_consumption_last_day}}";
  // Convert from string to arrry, change entries from strings to numbers, then sum every all entries
  let sumDailyEnergyUse = pastDay.split(",").map(e => Number(e)).reduce((a, b) => {return a + b});
  // Apply value to correct page element
  document.getElementById("dailyEnergyUse").innerHTML = sumDailyEnergyUse + " kWh";

  
  console.log(pastDay);
  console.log(typeof(pastDay));

  let x = 5; //minutes interval
  let times = []; // time array
  let tt = 0; // start time
  let ap = ['AM', 'PM']; // AM-PM

  //loop to increment the time and push results in array
  for (let i = 0; tt < 24 * 60; i++) {
    let hh = Math.floor(tt / 60); // getting hours of day in 0-24 format
    let mm = (tt % 60); // getting minutes of the hour in 0-55 format
    times[i] = ("0" + (hh % 12)).slice(-2) + ':' + ("0" + mm).slice(-2) + ap[Math.floor(hh / 12)]; // pushing data in array in [00:00 - 12:00 AM/PM format]
    tt = tt + x;
  }
  //console.log(times);
  let ctx = document.getElementById("deviceEnergy").getContext("2d");
  let chart = new Chart(ctx, {
    // The type of chart we want to create
    type: "line",
    data: {
      labels: times,
      datasets: [
        {
          label: "Device Energy Consumption (kWh)",
          borderColor: "rgb(99, 132, 255)",
          fill: false,
          data: pastDay,
          yAxisID: 'y',
        },
      ],
    },
    // Configuration options go here
    options: {
      stacked: true,
      scales: {
        yAxes: [{
          id: 'y',
          scaleLabel: {
            display: true,
            labelString: 'kWh'
          },
          position: 'left',
          display: true,
          ticks: {
            min: 0,
            suggestedMax: 0.5,
          },
        }]
      },
      elements: {
        point: {
          radius: 0,
          hitRadius: 10,
          hoverRadius: 10
        }
      }
    }
  });
</script>

{% endblock %}